<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript">
			function ready() {
				if (!!window.EventSource) {
					setupEventSource();
				} else {
					document.getElementById('status').innerHTML =
						"Sorry but your browser doesn't support the EventSource API";
				}
			}

			function setupEventSource() {
			  var lastId = localStorage.getItem('lastId') || ''
			  var uri = '/events/user@' + location.hash.replace('#', '') + '/' + lastId
				var source = new EventSource(uri);

				source.onmessage = function(e) {
				  localStorage.setItem(e.lastEventId, e.data)
				  localStorage.setItem('lastId', e.lastEventId)
				  console.log(e);
				};

				source.addEventListener('deal', async function(e) {
				  localStorage.setItem(e.lastEventId, e.data)
				  localStorage.setItem('lastId', e.lastEventId)
				  const data = JSON.parse(e.data);
				  const f = await fetch("/rest/deal/" + data.id)
				  const deal = await f.json()
					addStatus("id: " + deal.id);
					addStatus("company: " + deal.company);
					addStatus("created: " + deal.created);
					addStatus("value: " + deal.value);
				}, false);

				source.addEventListener('open', function(event) {
					console.log('eventsource connected.')
				}, false);

				source.addEventListener('error', function(event) {
					if (event.eventPhase == EventSource.CLOSED) {
						console.log('eventsource was closed.')
					}
				}, false);
			}

			function addStatus(text) {
				document.getElementById('status').innerHTML
				= document.getElementById('status').innerHTML
				+ text + "<br/>";
			}
		</script>
	</head>
	<body onload="ready();">
		Hi!
		<div id="status"></div>
	</body>
</html>
